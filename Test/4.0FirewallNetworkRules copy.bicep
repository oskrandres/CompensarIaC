
//suscripcion Oscar 18bf3718-f695-4c96-8d45-72dc2e617d2e
//RG Oscar rg-platfr-secuty-privte-trv-i
//suscripcion Compensar 71bcfecb-881e-4957-8d57-800172d61ee6
//RG Compensar rg-platfr-netwrk-centrl-trv-i

param ipGroups_ipgroup_azsnet_aks_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-aks'
param ipGroups_ipgroup_azsnet_apim_externalid string  = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-apim'
param ipGroups_ipgroup_azsnet_app_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-app'
param ipGroups_ipgroup_azsnet_db_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-db'
param ipGroups_ipgroup_azsnet_dbw_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dbw'
param ipGroups_ipgroup_azsnet_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmctrl'
param ipGroups_ipgroup_azsnet_dmz_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmz'
param ipGroups_ipgroup_azsnet_st_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-st'
param ipGroups_ipgroup_azsnet_vault_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-vault'
param ipGroups_ipgroup_azvnet_dvl_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-dvl-i'
param ipGroups_ipgroup_azvnet_poc_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-poc-i'
param ipGroups_ipgroup_azvnet_prd_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prd-i'
param ipGroups_ipgroup_azvnet_prp_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prp-i'
param ipGroups_ipgroup_azvnet_trv_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-trv-i'
param ipGroups_ipgroup_azvnet_tst_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-tst-i'
param ipGroups_ipgroup_opvlan_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-dmctrl'
param ipGroups_ipgroup_opvlan_scanng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-scanng'
param ipGroups_ipgroup_opvlan_testng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-testng'
param ipGroups_ipgroup_opvlan_vpnsec_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-vpnsec'
param ipGroups_ipgroup_opvlan_wificp_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-wificp'

param firewallPolicyName string = 'afwp-afw-secuty-public-centrl-trv-i'

resource fp 'Microsoft.Network/firewallPolicies@2024-05-01' existing = {
  name: firewallPolicyName
}

resource rcg_RCG_NET_TRV_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-TRV-I'
  parent: fp
  properties: {
    priority: 1000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-az-vnets-hubtrv-to-spokes (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-hubtrv-to-spokes'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-api'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_apim_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-vault'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_vault_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-st'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_st_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-lb-aks-medpre'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationAddresses: [ '10.89.27.250','10.89.155.250','10.203.27.250' ]
            destinationPorts: [ '443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-datalh-mgment-govern-trv-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-datalh-mgment-govern-trv-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-pview-mgment-govern-datcat-trv-i-to-op-vmprumeta'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.64/26' ]
            destinationAddresses: [ '192.168.19.111' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-pview-mgment-govern-datcat-trv-i-to-op-vmdripoll'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.64/26' ]
            destinationAddresses: [ '192.168.20.61' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vsqlavgpru01'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.12' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdusumacinta'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.209.30' ]
            // Excel: 8284.8289999999997 -> saneado a 8284,8289
            destinationPorts: [ '8284','8289' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdmiles'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.19.205' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdliberia'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.108' ]
            // Excel: 1433.60745 -> saneado a 1433,60745
            destinationPorts: [ '1433','60745' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdmocoa'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.209.24' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdvaupes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.19.37' ]
            destinationPorts: [ '445' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vpruxcaret'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.91' ]
            destinationPorts: [ '8085','8284','8290' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vpruxplor'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.92' ]
            destinationPorts: [ '57869' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprujanabiyah'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.70' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprulisboa'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.109' ]
            destinationPorts: [ '8290' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprudutu'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.57' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-platfr-mngmnt-centrl-trv-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-platfr-mngmnt-centrl-trv-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.89.23.250' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.89.151.250' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.203.23.250' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
    ]
  }
}

resource rcg_RCG_NET_PRD_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-PRD-I'
  parent: fp
  properties: {
    priority: 2000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-rg-transv-introp-apibus-prd-i (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-apibus-prd-i'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vmprhesbbw01-to-ip-apim-introp-apibus-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.240' ]
            destinationAddresses: [ '10.203.1.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmprhesbbw01-to-fqdn-apim-introp-apibus-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.240' ]
            destinationFqdns: [ 'api-transv-introp.prdaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmprhesbbw02-to-ip-apim-introp-apibus-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.241' ]
            destinationAddresses: [ '10.203.1.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmprhesbbw02-to-fqdn-apim-introp-apibus-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.241' ]
            destinationFqdns: [ 'api-transv-introp.prdaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-transv-introp-centrl-prd-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-centrl-prd-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-introp-centrl-manage-prd-i-to-op-gclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.16.0/22' ]
            destinationAddresses: [ '192.168.4.8' ]
            destinationPorts: [ '443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-gclint-syncro-stream-prd-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-gclint-syncro-stream-prd-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-syncro-stream-transc-prd-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.12.32/27' ]
            destinationAddresses: [ '192.168.207.19','192.168.207.20','192.168.207.21','192.168.207.23' ]
            destinationPorts: [ '1443' ]
          }
          {
            name: 'rule-asp-syncro-stream-trvmdm-prd-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.13.96/28' ]
            destinationAddresses: [ '192.168.207.19','192.168.207.20','192.168.207.21','192.168.207.23' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-transv-logsce-centrl-prd-i (priority 130)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-logsce-centrl-prd-i'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-logsce-centrl-srvlog-prd-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.13.160/27' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-mdmtrv-ebxtdv-centrl-prd-i (priority 140)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-mdmtrv-ebxtdv-centrl-prd-i'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-ebxtdv-centrl-manage-prd-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.20.0/22' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
          {
            name: 'rule-op-etlbd-to-st-ebxtdv-centrl-loadfs-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.207.124/32' ]
            destinationAddresses: [ '10.203.5.0/24' ]
            destinationPorts: [ '139','443','445' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-csalud-medpre-transv-prd-i (priority 150)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-csalud-medpre-transv-prd-i'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-medpre-transv-manage-dvl-i-to-ip-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.24.0/22' ]
            destinationAddresses: [ '192.168.3.17/32' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-aks-medpre-transv-manage-dvl-i-to-fqdn-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.24.0/22' ]
            destinationFqdns: [ 'esbintprdtls.compensar.com' ]
            destinationPorts: [ '443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-bibatr-bibaf2-centrl-prd-i (priority 160)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-bibaf2-centrl-prd-i'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vm-bibaf2-centrl-ingest-prd-i-to-op-bdsqlclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.0/23' ]
            destinationAddresses: [ '192.168.207.7','192.168.207.19' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-bibatr-financ-dkcart-prd-i (priority 170)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-financ-dkcart-prd-i'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
    ]
  }
    // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
  ]
}

resource rcg_RCG_NET_PRP_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-PRP-I'
  parent: fp
  properties: {
    priority: 3000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-rg-transv-introp-apibus-prp-i (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-apibus-prp-i'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vmpprhesbbw01-to-ip-apim-introp-apibus-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.194' ]
            destinationAddresses: [ '10.205.1.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmpprhesbbw01-to-fqdn-apim-introp-apibus-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.194' ]
            destinationFqdns: [ 'api-transv-introp.prpaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmpprhesbbw02-to-ip-apim-introp-apibus-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.195' ]
            destinationAddresses: [ '10.205.1.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmpprhesbbw02-to-fqdn-apim-introp-apibus-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.195' ]
            destinationFqdns: [ 'api-transv-introp.prpaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-introp-centrl-prp-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-centrl-prp-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-introp-centrl-manage-prp-i-to-op-gclientespru'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.205.16.0/22' ]
            destinationAddresses: [ '192.168.1.13' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-gclint-syncro-stream-prp-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-gclint-syncro-stream-prp-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-syncro-stream-transc-prp-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.205.12.32/27' ]
            destinationAddresses: [ '192.168.208.12' ]
            destinationPorts: [ '1443' ]
          }
          {
            name: 'rule-asp-syncro-stream-trvmdm-prp-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.205.13.96/28' ]
            destinationAddresses: [ '192.168.208.12' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-logsce-centrl-prp-i (priority 130)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-logsce-centrl-prp-i'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-logsce-centrl-srvlog-prp-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.205.13.160/27' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-mdmtrv-ebxtdv-centrl-prp-i (priority 140)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-mdmtrv-ebxtdv-centrl-prp-i'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-ebxtdv-centrl-manage-prp-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.205.20.0/22' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
          {
            name: 'rule-op-etlbd-to-st-ebxtdv-centrl-loadfs-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.208.201/32' ]
            destinationAddresses: [ '10.205.5.0/24' ]
            destinationPorts: [ '139','443','445' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-csalud-medpre-transv-prp-i (priority 150)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-csalud-medpre-transv-prp-i'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-bibaf2-centrl-prp-i (priority 160)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-bibaf2-centrl-prp-i'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-financ-dkcart-prp-i (priority 170)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-financ-dkcart-prp-i'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
  ]
}

resource rcg_RCG_NET_TST_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-TST-I'
  parent: fp
  properties: {
    priority: 4000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-rg-transv-introp-apibus-tst-i (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-apibus-tst-i'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vmprurhesb01-to-ip-apim-introp-apibus-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.148' ]
            destinationAddresses: [ '10.89.129.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmprurhesb01-to-fqdn-apim-introp-apibus-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.148' ]
            destinationFqdns: [ 'api-transv-introp.tstaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-introp-centrl-tst-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-centrl-tst-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-introp-centrl-manage-tst-i-to-op-gclientespru'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.144.0/22' ]
            destinationAddresses: [ '192.168.1.13' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-gclint-syncro-stream-tst-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-gclint-syncro-stream-tst-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-syncro-stream-transc-tst-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.140.32/27' ]
            destinationAddresses: [ '192.168.20.238','192.168.20.230' ]
            destinationPorts: [ '1443' ]
          }
          {
            name: 'rule-asp-syncro-stream-trvmdm-tst-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.141.96/28' ]
            destinationAddresses: [ '192.168.20.238','192.168.20.230' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-logsce-centrl-tst-i (priority 130)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-logsce-centrl-tst-i'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-logsce-centrl-srvlog-tst-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.141.160/27' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-mdmtrv-ebxtdv-centrl-tst-i (priority 140)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-mdmtrv-ebxtdv-centrl-tst-i'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-ebxtdv-centrl-manage-tst-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.148.0/22' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
          {
            name: 'rule-op-etlbd-to-st-ebxtdv-centrl-loadfs-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.208.201/32' ]
            destinationAddresses: [ '10.89.133.0/24' ]
            destinationPorts: [ '139','443','445' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-csalud-medpre-transv-tst-i (priority 150)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-csalud-medpre-transv-tst-i'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-medpre-transv-manage-tst-i-to-ip-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.152.0/22' ]
            destinationAddresses: [ '192.168.1.78/32' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-aks-medpre-transv-manage-tst-i-to-fqdn-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.152.0/22' ]
            destinationFqdns: [ 'esbintprutls.compensar.com' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-bibaf2-centrl-tst-i (priority 160)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-bibaf2-centrl-tst-i'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vm-bibaf2-centrl-ingest-tst-i-to-op-bdsqlclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.0/23' ]
            destinationAddresses: [ '192.168.208.12','192.168.208.57','192.168.209.24' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-financ-dkcart-tst-i (priority 170)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-financ-dkcart-tst-i'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
  ]
}

resource rcg_RCG_NET_DVL_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-DVL-I'
  parent: fp
  properties: {
    priority: 5000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-rg-transv-introp-apibus-dvl-i (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-apibus-dvl-i'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vmdrhesb01-to-ip-apim-introp-apibus-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.119' ]
            destinationAddresses: [ '10.89.1.0/28' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-op-vmdrhesb01-to-fqdn-apim-introp-apibus-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.18.162.119' ]
            destinationFqdns: [ 'api-transv-introp.dvlaz.compensar.int' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-introp-centrl-dvl-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-introp-centrl-dvl-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-introp-centrl-manage-dvl-i-to-op-gclientespru'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.16.0/22' ]
            destinationAddresses: [ '192.168.1.13' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-gclint-syncro-stream-dvl-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-gclint-syncro-stream-dvl-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-syncro-stream-transc-dvl-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.12.32/27' ]
            destinationAddresses: [ '192.168.20.238','192.168.20.230' ]
            destinationPorts: [ '1443' ]
          }
          {
            name: 'rule-asp-syncro-stream-trvmdm-dvl-i-to-op-bdcomclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.13.96/28' ]
            destinationAddresses: [ '192.168.20.238','192.168.20.230' ]
            destinationPorts: [ '1443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-transv-logsce-centrl-dvl-i (priority 130)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-transv-logsce-centrl-dvl-i'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-asp-logsce-centrl-srvlog-dvl-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.13.160/27' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-mdmtrv-ebxtdv-centrl-dvl-i (priority 140)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-mdmtrv-ebxtdv-centrl-dvl-i'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-ebxtdv-centrl-manage-dvl-i-to-smtp-outook.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.20.0/22' ]
            destinationAddresses: [ '40.96.0.0/13','40.104.0.0/15','52.96.0.0/14' ]
            destinationPorts: [ '587' ]
          }
          {
            name: 'rule-op-etlbd-to-st-ebxtdv-centrl-loadfs-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.208.201/32' ]
            destinationAddresses: [ '10.89.5.0/24' ]
            destinationPorts: [ '139','443','445' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-csalud-medpre-transv-dvl-i (priority 150)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-csalud-medpre-transv-dvl-i'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-aks-medpre-transv-manage-dvl-i-to-ip-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.24.0/22' ]
            destinationAddresses: [ '192.168.1.78/32' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-aks-medpre-transv-manage-dvl-i-to-fqdn-op-bus-tibco'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.24.0/22' ]
            destinationFqdns: [ 'esbintprutls.compensar.com' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-bibaf2-centrl-dvl-i (priority 160)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-bibaf2-centrl-dvl-i'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vm-bibaf2-centrl-ingest-dvl-i-to-op-bdsqlclientes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.0/23' ]
            destinationAddresses: [ '192.168.208.12','192.168.208.57','192.168.209.24' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }
      // ----------------------------------------------------------
      // rc-rg-bibatr-financ-dkcart-dvl-i (priority 170)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-bibatr-financ-dkcart-dvl-i'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-dbw-financ-dkcart-transc-pub-dvl-i-to-op-vmdvaupes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.9.128/26' ]
            destinationAddresses: [ '192.168.19.37' ]
            destinationPorts: [ '445' ]
          }
          {
            name: 'rule-dbw-financ-dkcart-transc-prv-dvl-i-to-op-vmdvaupes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.9.192/26' ]
            destinationAddresses: [ '192.168.19.37' ]
            destinationPorts: [ '445' ]
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
  ]
}

resource rcg_RCG_NET_POC_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-POC-I'
  parent: fp
  properties: {
    priority: 6000
    ruleCollections: [
      {
        name: 'rc-placeholder-no-rules'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
  ]
}


resource rcg_RCG_NET_COMMON 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-COMMON'
  parent: fp
  properties: {
    priority: 7000
    ruleCollections: [
      // ----------------------------------------------------------
      // Domain Controllers (bidireccional) – priority 100
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-domain-controllers'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-vnets-to-az-domain-controllers'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationIpGroups: [ ipGroups_ipgroup_opvlan_dmctrl_externalid ]
            destinationPorts: [ '42','53','88','123','135','137','138','139','389','445','464','500','636','3268','3269','3389','4500','1024-5000','49152-65535' ]
          }
          {
            name: 'rule-az-vnets-to-az-domain-controllers-reverse'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [ ipGroups_ipgroup_opvlan_dmctrl_externalid ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '42','53','88','123','135','137','138','139','389','445','464','500','636','3268','3269','3389','4500','1024-5000','49152-65535' ]
          }
          {
            name: 'rule-az-vnets-to-op-domain-controllers'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_dmctrl_externalid ]
            destinationPorts: [ '42','53','88','123','135','137','138','139','389','445','464','500','636','3268','3269','3389','4500','1024-5000','49152-65535' ]
          }
          {
            name: 'rule-az-vnets-to-op-domain-controllers-reverse'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azsnet_dmctrl_externalid ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '42','53','88','123','135','137','138','139','389','445','464','500','636','3268','3269','3389','4500','1024-5000','49152-65535' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // DNS Resolution – priority 110
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-dns-resolution'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-vnets-to-az-dns'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_dmctrl_externalid ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-az-vnets-to-op-dns'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationIpGroups: [ ipGroups_ipgroup_opvlan_dmctrl_externalid ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-az-vnets-to-internet-dns'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationAddresses: [ '168.63.129.16', '1.1.1.1', '8.8.8.8' ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-az-vnets-to-az-dnspr-netwrk-centrl-dnsppl-trv-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azvnet_trv_i_externalid ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
            ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-az-vnets-to-az-dnspr-netwrk-centrl-dnsppl-trv-i-reverse'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
            ]
            destinationIpGroups: [ ipGroups_ipgroup_azvnet_trv_i_externalid ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-dnspr-netwrk-centrl-dnsppl-trv-i-to-op-domain-controllers'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceAddresses: [ '10.204.2.0/25' ]
            destinationIpGroups: [ ipGroups_ipgroup_opvlan_dmctrl_externalid ]
            destinationPorts: [ '53' ]
          }
          {
            name: 'rule-dnspr-netwrk-centrl-dnsppl-trv-i-to-op-domain-controllers-reverse'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [ ipGroups_ipgroup_opvlan_dmctrl_externalid ]
            destinationAddresses: [ '10.204.2.0/25' ]
            destinationPorts: [ '53' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // KAV Antivirus – priority 120
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-kav-antivirus'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-vnets-to-op-kav-antivirus'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationAddresses: [ '192.168.204.71','192.168.204.99' ]
            destinationPorts: [ '80','135','137','139','443','445','902','9071','9101','9103','11111','13000','13291','13292','14000','15000','18000','20030','20200','25004','25007-25011','31001','41000','6109','1024-65535' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // DevOps Agent – priority 130
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-devops-agent'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-devops-to-az-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.5','10.204.3.6' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '22','53','80','135','443','1000','1433','2179','2382','2383','3389','6380','6901','6910','8080','8081','8100','9050','9191','10000-20000','17012','49152-65535' ]
          }
          {
            name: 'rule-az-devops-to-spokes-snet-db'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.5','10.204.3.6' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_db_externalid ]
            destinationPorts: [ '20000-30000','40000-43000' ]
          }
          {
            name: 'rule-op-devops-to-spokes-snet-db'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.204.225','192.168.204.227' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_db_externalid ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-az-devops-to-spokes-snet-psql-medpre'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.5','10.204.3.6' ]
            destinationAddresses: [ '10.89.6.0/28','10.89.134.0/28','10.205.6.0/28','10.203.6.0/28' ]
            destinationPorts: [ '5432' ]
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
  ]
}

resource rcg_RCG_NET_INTERNET 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-INTERNET'
  parent: fp
  properties: {
    priority: 8000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-az-vnets-to-azure-resources-agents (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-azure-resources-agents'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-snet-apim-to-ip-azure-agent-apimgmnt-microsoftmetrics.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azsnet_apim_externalid ]
            destinationAddresses: [ '52.183.41.0/24','13.92.0.0/16' ]
            destinationPorts: [ '1886' ]
          }
          {
            name: 'rule-snet-apim-to-fqdn-azure-agent-apimgmnt-microsoftmetrics.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azsnet_apim_externalid ]
            destinationFqdns: [ 'prod3.prod.microsoftmetrics.com' ]
            destinationPorts: [ '1886' ]
          }
          {
            name: 'rule-snet-dbw-to-ip-azure-agent-databricks-sql'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azsnet_dbw_externalid ]
            destinationAddresses: [ '40.70.0.0/16' ]
            destinationPorts: [ '1433','3306','9093' ]
          }
          {
            name: 'rule-snet-dbw-to-fqdn-azure-agent-databricks-sql'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [ ipGroups_ipgroup_azsnet_dbw_externalid ]
            destinationFqdns: [ ]
            destinationPorts: [ '1433','3306','9093' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-az-vnets-to-fqdn-internet (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-to-fqdn-internet'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vnets-to-ip-small-ivory-gazelle.rmq3.cloudamqp.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationAddresses: [ '20.110.121.0/24' ]
            destinationPorts: [ '443','5672' ] // saneo de 443.56720000000001
          }
          {
            name: 'rule-vnets-to-fqdn-small-ivory-gazelle.rmq3.cloudamqp.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationFqdns: [ 'small-ivory-gazelle.rmq3.cloudamqp.com' ]
            destinationPorts: [ '443','5672' ] // saneo de 443.56720000000001
          }
          {
            name: 'rule-vnets-to-fqdn-batch.e-collect.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationFqdns: [ 'fqdn-batch.e-collect.com' ]
            destinationPorts: [ '22','445' ] // saneo de 22.445
          }
          {
            name: 'rule-snets-aks-medpre-transv-manage-to-fqdn-mware-assist-preprod.grupoemi.com'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.16.0/20','10.89.144.0/20','10.203.16.0/20' ]
            destinationFqdns: [ 'mware-assist-preprod.grupoemi.com' ]
            destinationPorts: [ '443','6078' ] // saneo de 443.6078
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
    rcg_RCG_NET_COMMON
  ]
}


resource rcg_RCG_NET_MGMT 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-MGMT'
  parent: fp
  properties: {
    priority: 9000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-op-vpn-to-az-vnets (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-op-vpn-to-az-vnets'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vpn-to-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '22','443','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-dmz'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_dmz_externalid
            ]
            destinationPorts: [ '22','443','3389','5671','5672','8080','9093' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-app'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_app_externalid
            ]
            destinationPorts: [ '22','443','3389','5671','5672','8080','9093' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-db'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_db_externalid
            ]
            destinationPorts: [ '135','139','445','1433','1434','4022','5432','5433','6380','11000-11999','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-st'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_st_externalid
            ]
            destinationPorts: [ '135','139','445','1433','1434','4022','5432','5433','6380','11000-11999','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-aks'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_aks_externalid
            ]
            destinationPorts: [ '80','443','8080','9400','9401','9402','9403','9404','9408','30143' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-op-vlans-to-az-vnets (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-op-vlans-to-az-vnets'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-bastion-to-spokes-snet-dmz'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.204.7','192.168.204.13','192.168.204.112','192.168.204.180' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_dmz_externalid
            ]
            destinationPorts: [ '22','135','443','445','1433','1434','3389','5432','5433','8080' ]
          }
          {
            name: 'rule-op-bastion-to-spokes-snet-app'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.204.7','192.168.204.13','192.168.204.112','192.168.204.180' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_app_externalid
            ]
            destinationPorts: [ '22','135','443','445','1433','1434','3389','5432','5433','8080' ]
          }
          {
            name: 'rule-op-wifi-corp-to-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.240.0/21' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '22','443','3389' ]
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
    rcg_RCG_NET_COMMON
  ]
}


resource rcg_RCG_NET_AUDIT_SCAN 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-AUDIT-SCAN'
  parent: fp
  properties: {
    priority: 10000
    ruleCollections: [
      // ----------------------------------------------------------
      // SOC / Vulnerability Scanners (Nexpose, etc.) – priority 100
      // ----------------------------------------------------------
      {
        name: 'rc-soc-vuln-scanners'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          // Escaneo TCP a puertos comunes
          {
            name: 'rule-soc-scan-to-az-vnets-common'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [ ipGroups_ipgroup_opvlan_scanng_externalid ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '21','22','23','25','53','80','110','123','135','139','143','389','443','445','464','500','636','993','995','1433','1521','2049','2375','2376','2382','2383','27017','3306','3389','5432','5671','5672','5900','5985','5986','6379','6380','8080','8081','8443','9000','9092','9200','10000-20000' ]
          }
          // Escaneo UDP básico (DNS/NTP)
          {
            name: 'rule-soc-scan-to-az-vnets-udp'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'UDP' ]
            sourceIpGroups: [ ipGroups_ipgroup_opvlan_scanng_externalid ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '53','123','500','4500' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // QA / JMeter (pruebas de carga hacia apps) – priority 110
      // ----------------------------------------------------------
      {
        name: 'rc-qa-jmeter-to-apps'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-testqa-jmeter-to-az-hosts'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP','UDP','ICMP' ]
            sourceAddresses: [ '10.204.5.240/28' ]
            destinationAddresses: [ '10.89.20.0/22','10.89.5.0/24' ]
            destinationPorts: [ '139','443','445','5671','5672','9093','9400','9401','9402','9403','30143' ]
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
    rcg_RCG_NET_COMMON
    rcg_RCG_NET_INTERNET
    rcg_RCG_NET_MGMT
  ]
}

resource rcg_RCG_NET_VPN_S2S 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-VPN-S2S'
  parent: fp
  properties: {
    priority: 11000
    ruleCollections: [
      // ----------------------------------------------------------
      // EVTT / Compensar Salud
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-compensar-salud-azure'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.89.24.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-bibanp-to-ip-stcsaludcarinibkupdbdvli'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.224.132' ]
            destinationAddresses: [ '10.89.5.33' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
          {
            name: 'rule-vpn-bibanp-to-fqdn-stcsaludcarinibkupdbdvli'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.224.132' ]
            destinationFqdns: [ 'stcsaludcarinibkupdbdvli.blob.core.windows.net' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-compensar-salud-azure'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.89.152.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-stcsaludcarinibkupdbtsti-to-ip-bibanp'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.133.97' ]
            destinationAddresses: [ '172.27.224.132' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-compensar-salud-azure'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.205.24.0/22' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      {
        name: 'rc-prd-i-vpn-to-compensar-salud-azure'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.203.24.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-adf-csalud-carini-inload-prd-i-to-bibap'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.47' ]
            destinationAddresses: [ '172.27.243.133' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }

      // ----------------------------------------------------------
      // AWS (preprod / prod)
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-compensar-ccf-aws'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-aws-subnet-db-preprod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.24.80.0/20','10.24.32.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-compensar-ccf-aws'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-aws-subnet-db-preprod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.24.80.0/20','10.24.32.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-compensar-ccf-aws'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-compensar-ccf-aws'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-aws-subnet-db-prod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.21.32.0/20','10.21.80.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // Ciel Digiturno
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-ciel-azure-digiturno'
        priority: 180
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-ciel-azure-digiturno'
        priority: 190
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-ciel-azure-digiturno'
        priority: 200
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-ciel-azure-digiturno'
        priority: 210
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // DigitalWare
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 220
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.204.224.65/32','10.238.94.6/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 230
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.204.224.65/32','10.238.94.6/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 240
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 250
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.204.224.66/32','10.238.90.198/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
    rcg_RCG_NET_COMMON
    rcg_RCG_NET_INTERNET
    rcg_RCG_NET_MGMT
    rcg_RCG_NET_AUDIT_SCAN
  ]
}

resource rcg_RCG_NET_TEMP 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-TEMP'
  parent: fp
  properties: {
    priority: 12000
    ruleCollections: [
      {
        name: 'rc-temp-windowed-exceptions'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        // Reglas temporales (agrega aquí según necesidad y elimina al vencer)
        rules: [ ]
      }
    ]
  }
  // Dependencias acumulativas
  dependsOn: [
    rcg_RCG_NET_TRV_I
    rcg_RCG_NET_PRD_I
    rcg_RCG_NET_PRP_I
    rcg_RCG_NET_TST_I
    rcg_RCG_NET_DVL_I
    rcg_RCG_NET_POC_I
    rcg_RCG_NET_COMMON
    rcg_RCG_NET_INTERNET
    rcg_RCG_NET_MGMT
    rcg_RCG_NET_AUDIT_SCAN
    rcg_RCG_NET_VPN_S2S
  ]
}
