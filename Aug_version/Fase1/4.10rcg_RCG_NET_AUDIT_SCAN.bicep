
//suscripcion Oscar 18bf3718-f695-4c96-8d45-72dc2e617d2e
//RG Oscar rg-platfr-secuty-privte-trv-i
//suscripcion Compensar 71bcfecb-881e-4957-8d57-800172d61ee6
//RG Compensar rg-platfr-netwrk-centrl-trv-i

param ipGroups_ipgroup_azsnet_aks_externalid string   = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-aks'
param ipGroups_ipgroup_azsnet_apim_externalid string  = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-apim'
param ipGroups_ipgroup_azsnet_app_externalid string   = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-app'
param ipGroups_ipgroup_azsnet_db_externalid string    = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-db'
param ipGroups_ipgroup_azsnet_dbw_externalid string   = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dbw'
param ipGroups_ipgroup_azsnet_dmctrl_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmctrl'
param ipGroups_ipgroup_azsnet_dmz_externalid string   = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmz'
param ipGroups_ipgroup_azsnet_st_externalid string    = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-st'
param ipGroups_ipgroup_azsnet_vault_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-vault'
param ipGroups_ipgroup_azvnet_dvl_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-dvl-i'
param ipGroups_ipgroup_azvnet_poc_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-poc-i'
param ipGroups_ipgroup_azvnet_prd_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prd-i'
param ipGroups_ipgroup_azvnet_prp_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prp-i'
param ipGroups_ipgroup_azvnet_trv_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-trv-i'
param ipGroups_ipgroup_azvnet_tst_i_externalid string = '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-tst-i'
param ipGroups_ipgroup_opvlan_dmctrl_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-dmctrl'
param ipGroups_ipgroup_opvlan_scanng_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-scanng'
param ipGroups_ipgroup_opvlan_testng_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-testng'
param ipGroups_ipgroup_opvlan_vpnsec_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-vpnsec'
param ipGroups_ipgroup_opvlan_wificp_externalid string= '/subscriptions/71bcfecb-881e-4957-8d57-800172d61ee6/resourceGroups/rg-platfr-secuty-privte-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-wificp'

param firewallPolicyName string = 'afwp-afw-secuty-public-centrl-trv-i'

resource fp 'Microsoft.Network/firewallPolicies@2024-05-01' existing = {
  name: firewallPolicyName
}

resource rcg_RCG_NET_AUDIT_SCAN 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-AUDIT-SCAN'
  parent: fp
  properties: {
    priority: 10000
    ruleCollections: [
      // ----------------------------------------------------------
      // SOC / Vulnerability Scanners – priority 100 (3 reglas)
      // ----------------------------------------------------------
      {
        name: 'rc-op-vulnerability-scanner-to-az-vnets'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          // 1) SOC general
          {
            name: 'rule-op-soc-to-az-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP', 'UDP', 'ICMP' ]
            sourceAddresses: [
              '192.168.173.161'
              '192.168.173.168'
              '192.168.173.169'
              '192.168.173.162'
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '*' ]
          }
          // 2) Engine Nexpose
          {
            name: 'rule-op-engine-nexpose-to-az-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP', 'UDP', 'ICMP' ]
            sourceAddresses: [
              '192.168.204.17'
              '192.168.204.246'
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '*' ]
          }
          // 3) Console Nexpose
          {
            name: 'rule-op-console-nexpose-to-az-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP', 'UDP', 'ICMP' ]
            sourceAddresses: [
              '192.168.204.86'
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '*' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // QA / JMeter – priority 110 (1 regla)
      // ----------------------------------------------------------
      {
        name: 'rc-op-performance-testing-to-az-vnets'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-az-testqa-jmeter-to-az-hosts'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP', 'UDP', 'ICMP' ]
            sourceAddresses: [ '10.204.5.240/28' ]
            destinationAddresses: [ '10.89.20.0/22', '10.89.5.0/24' ]
            destinationPorts: [ '139','443','445','5671','5672','9093','9400','9401','9402','9403','30143' ]
          }
        ]
      }
    ]
  }
}
