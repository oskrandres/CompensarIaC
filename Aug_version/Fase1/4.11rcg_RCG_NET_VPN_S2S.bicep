
//suscripcion Oscar 18bf3718-f695-4c96-8d45-72dc2e617d2e
//RG Oscar rg-platfr-secuty-privte-trv-i
//suscripcion Compensar 71bcfecb-881e-4957-8d57-800172d61ee6
//RG Compensar rg-platfr-netwrk-centrl-trv-i

param ipGroups_ipgroup_azsnet_aks_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-aks'
param ipGroups_ipgroup_azsnet_apim_externalid string  = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-apim'
param ipGroups_ipgroup_azsnet_app_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-app'
param ipGroups_ipgroup_azsnet_db_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-db'
param ipGroups_ipgroup_azsnet_dbw_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dbw'
param ipGroups_ipgroup_azsnet_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmctrl'
param ipGroups_ipgroup_azsnet_dmz_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmz'
param ipGroups_ipgroup_azsnet_st_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-st'
param ipGroups_ipgroup_azsnet_vault_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-vault'
param ipGroups_ipgroup_azvnet_dvl_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-dvl-i'
param ipGroups_ipgroup_azvnet_poc_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-poc-i'
param ipGroups_ipgroup_azvnet_prd_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prd-i'
param ipGroups_ipgroup_azvnet_prp_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prp-i'
param ipGroups_ipgroup_azvnet_trv_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-trv-i'
param ipGroups_ipgroup_azvnet_tst_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-tst-i'
param ipGroups_ipgroup_opvlan_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-dmctrl'
param ipGroups_ipgroup_opvlan_scanng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-scanng'
param ipGroups_ipgroup_opvlan_testng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-testng'
param ipGroups_ipgroup_opvlan_vpnsec_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-vpnsec'
param ipGroups_ipgroup_opvlan_wificp_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-wificp'

param firewallPolicyName string = 'afwp-afw-secuty-public-centrl-trv-i'

resource fp 'Microsoft.Network/firewallPolicies@2024-05-01' existing = {
  name: firewallPolicyName
}

resource rcg_RCG_NET_VPN_S2S 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-VPN-S2S'
  parent: fp
  properties: {
    priority: 11000
    ruleCollections: [
      // ----------------------------------------------------------
      // EVTT / Compensar Salud
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-compensar-salud-azure'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.89.24.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-bibanp-to-ip-stcsaludcarinibkupdbdvli'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.224.132' ]
            destinationAddresses: [ '10.89.5.33' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
          {
            name: 'rule-vpn-bibanp-to-fqdn-stcsaludcarinibkupdbdvli'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.224.132' ]
            destinationFqdns: [ 'stcsaludcarinibkupdbdvli.blob.core.windows.net' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-compensar-salud-azure'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.89.152.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-stcsaludcarinibkupdbtsti-to-ip-bibanp'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.133.97' ]
            destinationAddresses: [ '172.27.224.132' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-compensar-salud-azure'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-prp-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.205.24.0/22' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
      {
        name: 'rc-prd-i-vpn-to-compensar-salud-azure'
        priority: 130
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-evtt-to-aks-medpre-transv-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '172.27.216.0/21' ]
            destinationAddresses: [ '10.203.24.0/22' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vpn-adf-csalud-carini-inload-prd-i-to-bibap'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.47' ]
            destinationAddresses: [ '172.27.243.133' ]
            destinationPorts: [ '53','443' ] // Excel: 53.442999999999998 -> 53,443
          }
        ]
      }

      // ----------------------------------------------------------
      // AWS (preprod / prod)
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-compensar-ccf-aws'
        priority: 140
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-aws-subnet-db-preprod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.24.80.0/20','10.24.32.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-compensar-ccf-aws'
        priority: 150
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-aws-subnet-db-preprod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.24.80.0/20','10.24.32.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-compensar-ccf-aws'
        priority: 160
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-compensar-ccf-aws'
        priority: 170
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-aws-subnet-db-prod'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.21.32.0/20','10.21.80.0/20' ]
            destinationPorts: [ '1433','1434','5432','27017' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // Ciel Digiturno
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-ciel-azure-digiturno'
        priority: 180
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-ciel-azure-digiturno'
        priority: 190
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-ciel-azure-digiturno'
        priority: 200
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-ciel-azure-digiturno'
        priority: 210
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-ciel-digiturno'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.204.224.4' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // DigitalWare
      // ----------------------------------------------------------
      {
        name: 'rc-dvl-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 220
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-dvl-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.2.35' ]
            destinationAddresses: [ '10.204.224.65/32','10.238.94.6/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
      {
        name: 'rc-tst-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 230
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-tst-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.89.130.28' ]
            destinationAddresses: [ '10.204.224.65/32','10.238.94.6/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
      {
        name: 'rc-prp-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 240
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [ ]
      }
      {
        name: 'rc-prd-i-vpn-to-digitalware-onpremise-andromeda'
        priority: 250
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vpn-vm-shared-rntime-intrun-prd-i-to-digitalware-andromeda'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.203.2.29' ]
            destinationAddresses: [ '10.204.224.66/32','10.238.90.198/32' ]
            destinationPorts: [ '1733' ]
          }
        ]
      }
    ]
  }
}
