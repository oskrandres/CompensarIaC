
//suscripcion Oscar 18bf3718-f695-4c96-8d45-72dc2e617d2e
//RG Oscar rg-platfr-secuty-privte-trv-i
//suscripcion Compensar 71bcfecb-881e-4957-8d57-800172d61ee6
//RG Compensar rg-platfr-netwrk-centrl-trv-i


param ipGroups_ipgroup_azsnet_aks_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-aks'
param ipGroups_ipgroup_azsnet_apim_externalid string  = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-apim'
param ipGroups_ipgroup_azsnet_app_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-app'
param ipGroups_ipgroup_azsnet_db_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-db'
param ipGroups_ipgroup_azsnet_dbw_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dbw'
param ipGroups_ipgroup_azsnet_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmctrl'
param ipGroups_ipgroup_azsnet_dmz_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmz'
param ipGroups_ipgroup_azsnet_st_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-st'
param ipGroups_ipgroup_azsnet_vault_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-vault'
param ipGroups_ipgroup_azvnet_dvl_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-dvl-i'
param ipGroups_ipgroup_azvnet_poc_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-poc-i'
param ipGroups_ipgroup_azvnet_prd_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prd-i'
param ipGroups_ipgroup_azvnet_prp_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prp-i'
param ipGroups_ipgroup_azvnet_trv_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-trv-i'
param ipGroups_ipgroup_azvnet_tst_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-tst-i'
param ipGroups_ipgroup_opvlan_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-dmctrl'
param ipGroups_ipgroup_opvlan_scanng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-scanng'
param ipGroups_ipgroup_opvlan_testng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-testng'
param ipGroups_ipgroup_opvlan_vpnsec_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-vpnsec'
param ipGroups_ipgroup_opvlan_wificp_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-wificp'


param firewallPolicyName string = 'afwp-afw-secuty-public-centrl-trv-i'

resource fp 'Microsoft.Network/firewallPolicies@2024-05-01' existing = {
  name: firewallPolicyName
}

resource rcg_RCG_NET_TRV_I 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-TRV-I'
  parent: fp
  properties: {
    priority: 1000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-az-vnets-hubtrv-to-spokes (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-az-vnets-hubtrv-to-spokes'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-api'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_apim_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-vault'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_vault_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-snet-st'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationIpGroups: [ ipGroups_ipgroup_azsnet_st_externalid ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-agw-secuty-public-centrl-trv-i-to-spokes-lb-aks-medpre'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.0.0/26' ]
            destinationAddresses: [ '10.89.27.250','10.89.155.250','10.203.27.250' ]
            destinationPorts: [ '443' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-datalh-mgment-govern-trv-i (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-datalh-mgment-govern-trv-i'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-pview-mgment-govern-datcat-trv-i-to-op-vmprumeta'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.64/26' ]
            destinationAddresses: [ '192.168.19.111' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-pview-mgment-govern-datcat-trv-i-to-op-vmdripoll'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.64/26' ]
            destinationAddresses: [ '192.168.20.61' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vsqlavgpru01'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.12' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdusumacinta'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.209.30' ]
            // Excel: 8284.8289999999997 -> saneado a 8284,8289
            destinationPorts: [ '8284','8289' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdmiles'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.19.205' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdliberia'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.108' ]
            // Excel: 1433.60745 -> saneado a 1433,60745
            destinationPorts: [ '1433','60745' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdmocoa'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.209.24' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmdvaupes'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.19.37' ]
            destinationPorts: [ '445' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vpruxcaret'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.91' ]
            destinationPorts: [ '8085','8284','8290' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vpruxplor'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.92' ]
            destinationPorts: [ '57869' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprujanabiyah'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.70' ]
            destinationPorts: [ '1433' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprulisboa'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.109' ]
            destinationPorts: [ '8290' ]
          }
          {
            name: 'rule-vm-mgment-govern-intrun-trv-i-to-op-vmprudutu'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.69' ]
            destinationAddresses: [ '192.168.208.57' ]
            destinationPorts: [ '1433' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-rg-platfr-mngmnt-centrl-trv-i (priority 120)
      // ----------------------------------------------------------
      {
        name: 'rc-rg-platfr-mngmnt-centrl-trv-i'
        priority: 120
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-dvl-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.89.23.250' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-tst-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.89.151.250' ]
            destinationPorts: [ '443' ]
          }
          {
            name: 'rule-vm-mngmnt-centrl-maskng-trv-i-to-aks-ebxtdv-centrl-manage-prd-i'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '10.204.3.7' ]
            destinationAddresses: [ '10.203.23.250' ]
            destinationPorts: [ '443' ]
          }
        ]
      }
    ]
  }
}
