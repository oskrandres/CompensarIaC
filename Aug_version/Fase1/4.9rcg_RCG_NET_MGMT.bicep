
//suscripcion Oscar 18bf3718-f695-4c96-8d45-72dc2e617d2e
//RG Oscar rg-platfr-secuty-privte-trv-i
//suscripcion Compensar 71bcfecb-881e-4957-8d57-800172d61ee6
//RG Compensar rg-platfr-netwrk-centrl-trv-i

param ipGroups_ipgroup_azsnet_aks_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-aks'
param ipGroups_ipgroup_azsnet_apim_externalid string  = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-apim'
param ipGroups_ipgroup_azsnet_app_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-app'
param ipGroups_ipgroup_azsnet_db_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-db'
param ipGroups_ipgroup_azsnet_dbw_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dbw'
param ipGroups_ipgroup_azsnet_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmctrl'
param ipGroups_ipgroup_azsnet_dmz_externalid string   = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-dmz'
param ipGroups_ipgroup_azsnet_st_externalid string    = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-st'
param ipGroups_ipgroup_azsnet_vault_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azsnet-vault'
param ipGroups_ipgroup_azvnet_dvl_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-dvl-i'
param ipGroups_ipgroup_azvnet_poc_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-poc-i'
param ipGroups_ipgroup_azvnet_prd_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prd-i'
param ipGroups_ipgroup_azvnet_prp_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-prp-i'
param ipGroups_ipgroup_azvnet_trv_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-trv-i'
param ipGroups_ipgroup_azvnet_tst_i_externalid string = '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-azvnet-tst-i'
param ipGroups_ipgroup_opvlan_dmctrl_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-dmctrl'
param ipGroups_ipgroup_opvlan_scanng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-scanng'
param ipGroups_ipgroup_opvlan_testng_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-testng'
param ipGroups_ipgroup_opvlan_vpnsec_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-vpnsec'
param ipGroups_ipgroup_opvlan_wificp_externalid string= '/subscriptions/18bf3718-f695-4c96-8d45-72dc2e617d2e/resourceGroups/rg-platfr-netwrk-centrl-trv-i/providers/Microsoft.Network/ipGroups/ipg-secuty-privte-opvlan-wificp'

param firewallPolicyName string = 'afwp-afw-secuty-public-centrl-trv-i'

resource fp 'Microsoft.Network/firewallPolicies@2024-05-01' existing = {
  name: firewallPolicyName
}

resource rcg_RCG_NET_MGMT 'Microsoft.Network/firewallPolicies/ruleCollectionGroups@2024-05-01' = {
  name: 'RCG-NET-MGMT'
  parent: fp
  properties: {
    priority: 9000
    ruleCollections: [
      // ----------------------------------------------------------
      // rc-op-vpn-to-az-vnets (priority 100)
      // ----------------------------------------------------------
      {
        name: 'rc-op-vpn-to-az-vnets'
        priority: 100
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-vpn-to-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '22','443','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-dmz'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_dmz_externalid
            ]
            destinationPorts: [ '22','443','3389','5671','5672','8080','9093' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-app'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_app_externalid
            ]
            destinationPorts: [ '22','443','3389','5671','5672','8080','9093' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-db'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_db_externalid
            ]
            destinationPorts: [ '135','139','445','1433','1434','4022','5432','5433','6380','11000-11999','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-st'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_st_externalid
            ]
            destinationPorts: [ '135','139','445','1433','1434','4022','5432','5433','6380','11000-11999','3389' ]
          }
          {
            name: 'rule-op-vpn-to-spokes-snet-aks'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceIpGroups: [
              ipGroups_ipgroup_opvlan_vpnsec_externalid
            ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_aks_externalid
            ]
            destinationPorts: [ '80','443','8080','9400','9401','9402','9403','9404','9408','30143' ]
          }
        ]
      }

      // ----------------------------------------------------------
      // rc-op-vlans-to-az-vnets (priority 110)
      // ----------------------------------------------------------
      {
        name: 'rc-op-vlans-to-az-vnets'
        priority: 110
        ruleCollectionType: 'FirewallPolicyFilterRuleCollection'
        action: { type: 'Allow' }
        rules: [
          {
            name: 'rule-op-bastion-to-spokes-snet-dmz'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.204.7','192.168.204.13','192.168.204.112','192.168.204.180' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_dmz_externalid
            ]
            destinationPorts: [ '22','135','443','445','1433','1434','3389','5432','5433','8080' ]
          }
          {
            name: 'rule-op-bastion-to-spokes-snet-app'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.204.7','192.168.204.13','192.168.204.112','192.168.204.180' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azsnet_app_externalid
            ]
            destinationPorts: [ '22','135','443','445','1433','1434','3389','5432','5433','8080' ]
          }
          {
            name: 'rule-op-wifi-corp-to-vnets'
            ruleType: 'NetworkRule'
            ipProtocols: [ 'TCP' ]
            sourceAddresses: [ '192.168.240.0/21' ]
            destinationIpGroups: [
              ipGroups_ipgroup_azvnet_dvl_i_externalid
              ipGroups_ipgroup_azvnet_tst_i_externalid
              ipGroups_ipgroup_azvnet_prp_i_externalid
              ipGroups_ipgroup_azvnet_prd_i_externalid
              ipGroups_ipgroup_azvnet_poc_i_externalid
              ipGroups_ipgroup_azvnet_trv_i_externalid
            ]
            destinationPorts: [ '22','443','3389' ]
          }
        ]
      }
    ]
  }
}
